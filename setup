#!/bin/bash

# Colors for aesthetic output
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}Error: This script must be run from within a git repository${NC}"
    exit 1
fi

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT" || exit 1

# Check if this is the phenom repository
if [ ! -f "mix.exs" ] || ! grep -q "app: :phenom" mix.exs; then
    echo -e "${RED}Error: This doesn't appear to be the phenom repository${NC}"
    exit 1
fi

# Print header
echo ""
echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║                                                           ║${NC}"
echo -e "${CYAN}║  ${MAGENTA}${BOLD}                    ⚡ PHENOM ⚡                      ${NC}${CYAN}   ║${NC}"
echo -e "${CYAN}║                                                           ║${NC}"
echo -e "${CYAN}║   An opinionated template for your new Phoenix project    ║${NC}"
echo -e "${CYAN}║                                                           ║${NC}"
echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""

# Function to convert snake_case to PascalCase
snake_to_pascal() {
    echo "$1" | awk -F_ '{for(i=1;i<=NF;i++){$i=toupper(substr($i,1,1)) substr($i,2)}} 1' OFS=""
}

# Function to validate app name (must be snake_case, lowercase, alphanumeric + underscore)
validate_app_name() {
    if [[ ! "$1" =~ ^[a-z][a-z0-9_]*$ ]]; then
        return 1
    fi
    return 0
}

# Function to validate GitHub handle (alphanumeric + hyphen, no spaces)
validate_github_handle() {
    if [[ ! "$1" =~ ^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?$ ]]; then
        return 1
    fi
    return 0
}

# Prompt for app name
echo -e "${BLUE}${BOLD}Step 1:${NC} What will your application be called?"
echo -e "${YELLOW}        (Use snake_case, e.g., my_awesome_app)${NC}\n"
while true; do
    echo -ne "${MAGENTA}→${NC} App name: "
    read -r NEW_APP_NAME
    
    if [ -z "$NEW_APP_NAME" ]; then
        echo -e "${RED}✗ App name cannot be empty${NC}\n"
        continue
    fi
    
    if ! validate_app_name "$NEW_APP_NAME"; then
        echo -e "${RED}✗ Invalid app name. Use lowercase snake_case (e.g., my_app)${NC}\n"
        continue
    fi
    
    break
done

NEW_APP_MODULE=$(snake_to_pascal "$NEW_APP_NAME")
echo -e "${GREEN}✓${NC} App name: ${GREEN}${BOLD}$NEW_APP_NAME${NC} (Module: ${GREEN}${BOLD}$NEW_APP_MODULE${NC})\n"

# Prompt for GitHub handle
echo -e "${BLUE}${BOLD}Step 2:${NC} What's your GitHub username or organization?"
echo -e "${YELLOW}        (This will be used for Docker image tags)${NC}\n"
while true; do
    echo -ne "${MAGENTA}→${NC} GitHub handle: "
    read -r NEW_GITHUB_HANDLE
    
    if [ -z "$NEW_GITHUB_HANDLE" ]; then
        echo -e "${RED}✗ GitHub handle cannot be empty${NC}\n"
        continue
    fi
    
    if ! validate_github_handle "$NEW_GITHUB_HANDLE"; then
        echo -e "${RED}✗ Invalid GitHub handle. Use alphanumeric characters and hyphens only${NC}\n"
        continue
    fi
    
    break
done

echo -e "${GREEN}✓${NC} GitHub handle: ${GREEN}${BOLD}$NEW_GITHUB_HANDLE${NC}\n"

# Confirmation
echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BOLD}Please confirm your selections:${NC}\n"
echo -e "  ${BLUE}App Name:${NC}       $NEW_APP_NAME"
echo -e "  ${BLUE}App Module:${NC}     $NEW_APP_MODULE"
echo -e "  ${BLUE}GitHub Handle:${NC}  $NEW_GITHUB_HANDLE"
echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}\n"

echo -ne "${YELLOW}Proceed with setup? [y/N]:${NC} "
read -r CONFIRM

if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo -e "\n${RED}Setup cancelled${NC}"
    exit 0
fi

echo -e "\n${GREEN}${BOLD}Starting setup...${NC}\n"

# Define old and new values
OLD_APP_NAME="phenom"
OLD_APP_MODULE="Phenom"
OLD_GITHUB_HANDLE="dimamik"

# Function to rename files and directories
rename_items() {
    echo -e "${CYAN}→${NC} Renaming files and directories..."
    
    # Find and rename files containing the old app name
    find . -depth -name "*${OLD_APP_NAME}*" -not -path "*/\.*" -not -path "*/deps/*" -not -path "*/_build/*" -not -path "*/node_modules/*" | while read -r file; do
        new_file=$(echo "$file" | sed "s/${OLD_APP_NAME}/${NEW_APP_NAME}/g")
        if [ "$file" != "$new_file" ]; then
            mv "$file" "$new_file" 2>/dev/null || true
            echo -e "  ${GREEN}✓${NC} Renamed: $file → $new_file"
        fi
    done
}

# Function to replace content in files
replace_content() {
    echo -e "${CYAN}→${NC} Updating file contents..."
    
    # Find all text files (excluding binary, deps, build, node_modules, git)
    find . -type f \
        -not -path "*/\.*" \
        -not -path "*/deps/*" \
        -not -path "*/_build/*" \
        -not -path "*/node_modules/*" \
        -not -path "*/*.beam" \
        -not -path "*/*.so" \
        -not -path "*/*.png" \
        -not -path "*/*.jpg" \
        -not -path "*/*.jpeg" \
        -not -path "*/*.gif" \
        -not -path "*/*.ico" \
        -not -path "*/*.woff*" \
        -not -path "*/*.ttf" \
        -not -path "*/*.eot" \
        | while read -r file; do
        
        # Check if file is text
        if file "$file" | grep -q "text"; then
            # Replace app module name (Phenom -> NewAppModule)
            sed -i.bak "s/${OLD_APP_MODULE}/${NEW_APP_MODULE}/g" "$file"
            
            # Replace app name (phenom -> new_app_name)
            sed -i.bak "s/${OLD_APP_NAME}/${NEW_APP_NAME}/g" "$file"
            
            # Replace GitHub handle (dimamik -> new_handle)
            sed -i.bak "s/${OLD_GITHUB_HANDLE}/${NEW_GITHUB_HANDLE}/g" "$file"
            
            # Remove backup file
            rm -f "${file}.bak"
        fi
    done
    
    echo -e "  ${GREEN}✓${NC} Content updated in all files"
}

# Execute setup steps
rename_items
replace_content

# Copy .env.sample to .env if it doesn't exist
if [ ! -f ".env" ]; then
    echo -e "${CYAN}→${NC} Creating .env file from template..."
    cp .env.sample .env
    echo -e "  ${GREEN}✓${NC} Created .env file"
else
    echo -e "${YELLOW}→${NC} .env file already exists, skipping..."
fi

echo -e "\n${GREEN}${BOLD}═══════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}${BOLD}✓ Setup complete!${NC}\n"
echo -e "Your application is ready"
echo -e "Module name: ${CYAN}${BOLD}$NEW_APP_MODULE${NC}"
echo -e "GitHub handle: ${CYAN}${BOLD}$NEW_GITHUB_HANDLE${NC}\n"

echo -e "${YELLOW}Next steps:${NC}"
echo -e "  1. Run ${CYAN}mix deps.get${NC} to fetch dependencies"
echo -e "  2. Run ${CYAN}mix ecto.setup${NC} to set up the database"
echo -e "  3. Run ${CYAN}mix phx.server${NC} to start your server"
echo -e "  4. Update your ${CYAN}.env${NC} file with production secrets"
echo -e "  5. Commit your changes: ${CYAN}git add . && git commit -m \"Setup: Rename app to $NEW_APP_NAME\"${NC}\n"

echo -e "${GREEN}${BOLD}═══════════════════════════════════════════════════════════${NC}\n"
